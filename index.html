<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AI Playground</title>

  <!-- External stylesheet -->
  <link rel="stylesheet" href="/style.css" />
</head>

<body>
  <h1>AI Playground</h1>
  <small>v0.2 – Copilot-style summarizer</small>

  <div class="controls">
    <label class="inline">
      <input type="checkbox" id="auto" checked />
      Auto-summarize on paste
    </label>

    <button id="debug-toggle" class="debug-toggle" aria-pressed="false" aria-controls="debug-panel" title="Toggle Token Inspector">Token Inspector</button>
  </div>
 
  <div class="buttons">
    <button data-mode="short" aria-pressed="false" onclick="selectPreset('short')">Short</button>
    <button data-mode="medium" aria-pressed="true" onclick="selectPreset('medium')">Medium</button>
    <button data-mode="detailed" aria-pressed="false" onclick="selectPreset('detailed')">Detailed</button>
    <button onclick="clearAll()" class="secondary">Clear</button>
    <button id="submit-btn" class="primary" onclick="submitPreset()" aria-label="Summarize current selection">Summarize</button>
  </div>

  <textarea id="input" placeholder="Paste text here..."></textarea>

  <div class="meta">
    <label>
      Max output chars:
      <input id="cap" type="number" value="900" min="200" max="5000" />
    </label>
    <span id="status"></span>
  </div>

  <section id="debug-panel" class="debug-panel" aria-expanded="false" aria-hidden="true" aria-label="Token Inspector Panel" style="display:none;">
    <div class="debug-header">
      <strong>Token Inspector</strong>
      <button id="debug-close" class="debug-close" aria-label="Close debug panel">Close</button>
    </div>
    <div class="debug-body">
      <div id="run-list" class="run-list" aria-live="polite"></div>
      <div id="run-inspector" class="run-inspector" hidden>
        <div class="inspector-tabs" role="tablist">
          <button role="tab" aria-selected="true" data-tab="prompt">Prompt</button>
          <button role="tab" aria-selected="false" data-tab="context">Context</button>
          <button role="tab" aria-selected="false" data-tab="request">Request</button>
          <button role="tab" aria-selected="false" data-tab="response">Response</button>
          <button role="tab" aria-selected="false" data-tab="logs">Logs</button>
        </div>
        <div id="inspector-content" class="inspector-content"></div>
      </div>
    </div>
  </section>

  <div class="output" id="output"></div>

  <script>
    const inputEl = document.getElementById("input");
    const outputEl = document.getElementById("output");
    const statusEl = document.getElementById("status");
    const capEl = document.getElementById("cap");
    const autoEl = document.getElementById("auto");
    const presetButtons = document.querySelectorAll('.buttons button[data-mode]');
 
    // Debug mode: persisted toggle & panel shell
    const DEBUG_KEY = 'ai_playground_debug';
    let debugEnabled = localStorage.getItem(DEBUG_KEY) === 'true';
    const debugToggleEl = () => document.getElementById('debug-toggle');
    const debugPanelEl = () => document.getElementById('debug-panel');
    const debugCloseEl = () => document.getElementById('debug-close');

    const runs = [];

    function applyDebugUIState() {
      const btn = debugToggleEl();
      const panel = debugPanelEl();
      if (!btn || !panel) return;
      btn.setAttribute('aria-pressed', debugEnabled ? 'true' : 'false');
      panel.setAttribute('aria-expanded', debugEnabled ? 'true' : 'false');
      panel.setAttribute('aria-hidden', debugEnabled ? 'false' : 'true');
      panel.style.display = debugEnabled ? 'block' : 'none';
      if (debugEnabled) document.body.classList.add('debug-open');
      else document.body.classList.remove('debug-open');
    }

    function toggleDebug() {
      debugEnabled = !debugEnabled;
      localStorage.setItem(DEBUG_KEY, debugEnabled ? 'true' : 'false');
      applyDebugUIState();
    }

    if (debugToggleEl()) debugToggleEl().addEventListener('click', toggleDebug);
    if (debugCloseEl()) debugCloseEl().addEventListener('click', () => { debugEnabled = false; localStorage.setItem(DEBUG_KEY, 'false'); applyDebugUIState(); });

    applyDebugUIState();

    let pasteTimer = null;
 
    inputEl.addEventListener("paste", () => {
      if (!autoEl.checked) return;
      clearTimeout(pasteTimer);
      pasteTimer = setTimeout(() => {
        let active = document.querySelector('.buttons button[data-mode][aria-pressed="true"]');
        if (!active) { selectPreset('medium'); active = document.querySelector('.buttons button[data-mode][aria-pressed="true"]'); }
        runPreset(active?.dataset.mode || 'medium');
      }, 250);
    });
 
    // ensure a default preset is set (fallback to medium)
    if (!document.querySelector('.buttons button[data-mode][aria-pressed="true"]')) {
      const fallback = document.querySelector('.buttons button[data-mode="medium"]');
      fallback && fallback.setAttribute('aria-pressed', 'true');
    }
 
    function clearAll() {
      inputEl.value = "";
      outputEl.innerText = "";
      statusEl.innerText = "";
      presetButtons.forEach(b => b.setAttribute('aria-pressed', 'false'));
    }

    function presetInstruction(mode, cap) {
      if (mode === "short") {
        return `Summarize in 5 bullets. Each bullet under 12 words. Total output under ${cap} characters.`;
      }
      if (mode === "medium") {
        return `Summarize in 8 bullets with 1 short takeaway line at the end. Total output under ${cap} characters.`;
      }
      return `Provide: (1) 10-bullet summary, (2) key definitions, (3) 3 suggested next actions. Total output under ${cap} characters.`;
    }

    async function runPreset(mode) {
      const text = inputEl.value || "";
      const cap = Math.max(200, Math.min(5000, Number(capEl.value || 900)));

      if (!text.trim()) {
        outputEl.innerText = "Paste some text first.";
        return;
      }

      const instruction = presetInstruction(mode, cap);
      const payload = `INSTRUCTION:\n${instruction}\n\nCONTENT:\n${text}`;

      statusEl.innerText = "Summarizing...";
      outputEl.innerText = "";

      const start = performance.now();

      try {
        const resp = await fetch("/api/summarize", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text: payload })
        });

        const data = await resp.json();
        const ms = Math.round(performance.now() - start);

        if (!resp.ok) {
          throw new Error(data?.error || `Request failed (${resp.status})`);
        }

        let out = (data.summary || "").trim();
        if (out.length > cap) {
          out = out.slice(0, cap - 1) + "…";
        }

        outputEl.innerText = out;
        statusEl.innerText = `Done (${ms} ms) • Mode: ${mode}`;
      } catch (err) {
        const ms = Math.round(performance.now() - start);
        statusEl.innerText = `Error (${ms} ms)`;
        outputEl.innerText = `Error: ${err.message || err}`;
      }
    }

    function selectPreset(mode) {
      // update pressed state only (do not auto-run)
      presetButtons.forEach(b => b.setAttribute('aria-pressed', b.dataset.mode === mode ? 'true' : 'false'));
    }

    function submitPreset() {
      let active = document.querySelector('.buttons button[data-mode][aria-pressed="true"]');
      if (!active) {
        selectPreset('medium');
        active = document.querySelector('.buttons button[data-mode][aria-pressed="true"]');
      }
      const mode = active?.dataset.mode || 'medium';
      runPreset(mode);
    }
  </script>
</body>
</html>
