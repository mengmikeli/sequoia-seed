<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AI Playground</title>

  <!-- External stylesheet -->
  <link rel="stylesheet" href="/style.css" />
</head>

<body>
  <h1>AI Playground</h1>
  <small>v0.2 – Copilot-style summarizer</small>

  <div class="controls">
    <label class="inline">
      <input type="checkbox" id="auto" checked />
      Auto-summarize on paste
    </label>
  </div>
 
  <div class="buttons">
    <button data-mode="short" aria-pressed="false" onclick="selectPreset('short')">Short</button>
    <button data-mode="medium" aria-pressed="true" onclick="selectPreset('medium')">Medium</button>
    <button data-mode="detailed" aria-pressed="false" onclick="selectPreset('detailed')">Detailed</button>
    <button onclick="clearAll()" class="secondary">Clear</button>
  </div>

  <textarea id="input" placeholder="Paste text here..."></textarea>

  <div class="meta">
    <label>
      Max output chars:
      <input id="cap" type="number" value="900" min="200" max="5000" />
    </label>
    <span id="status"></span>
  </div>

  <div class="output" id="output"></div>

  <script>
    const inputEl = document.getElementById("input");
    const outputEl = document.getElementById("output");
    const statusEl = document.getElementById("status");
    const capEl = document.getElementById("cap");
    const autoEl = document.getElementById("auto");
    const presetButtons = document.querySelectorAll('.buttons button[data-mode]');
 
    let pasteTimer = null;
 
    inputEl.addEventListener("paste", () => {
      if (!autoEl.checked) return;
      clearTimeout(pasteTimer);
      pasteTimer = setTimeout(() => {
        const active = document.querySelector('.buttons button[data-mode][aria-pressed="true"]');
        selectPreset(active?.dataset.mode || 'medium');
      }, 250);
    });
 
    // ensure a default preset is set (fallback to medium)
    if (!document.querySelector('.buttons button[data-mode][aria-pressed="true"]')) {
      const fallback = document.querySelector('.buttons button[data-mode="medium"]');
      fallback && fallback.setAttribute('aria-pressed', 'true');
    }
 
    function clearAll() {
      inputEl.value = "";
      outputEl.innerText = "";
      statusEl.innerText = "";
      presetButtons.forEach(b => b.setAttribute('aria-pressed', 'false'));
    }

    function presetInstruction(mode, cap) {
      if (mode === "short") {
        return `Summarize in 5 bullets. Each bullet under 12 words. Total output under ${cap} characters.`;
      }
      if (mode === "medium") {
        return `Summarize in 8 bullets with 1 short takeaway line at the end. Total output under ${cap} characters.`;
      }
      return `Provide: (1) 10-bullet summary, (2) key definitions, (3) 3 suggested next actions. Total output under ${cap} characters.`;
    }

    async function runPreset(mode) {
      const text = inputEl.value || "";
      const cap = Math.max(200, Math.min(5000, Number(capEl.value || 900)));

      if (!text.trim()) {
        outputEl.innerText = "Paste some text first.";
        return;
      }

      const instruction = presetInstruction(mode, cap);
      const payload = `INSTRUCTION:\n${instruction}\n\nCONTENT:\n${text}`;

      statusEl.innerText = "Summarizing...";
      outputEl.innerText = "";

      const start = performance.now();

      try {
        const resp = await fetch("/api/summarize", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text: payload })
        });

        const data = await resp.json();
        const ms = Math.round(performance.now() - start);

        if (!resp.ok) {
          throw new Error(data?.error || `Request failed (${resp.status})`);
        }

        let out = (data.summary || "").trim();
        if (out.length > cap) {
          out = out.slice(0, cap - 1) + "…";
        }

        outputEl.innerText = out;
        statusEl.innerText = `Done (${ms} ms) • Mode: ${mode}`;
      } catch (err) {
        const ms = Math.round(performance.now() - start);
        statusEl.innerText = `Error (${ms} ms)`;
        outputEl.innerText = `Error: ${err.message || err}`;
      }
    }

    function selectPreset(mode) {
      // update pressed state
      presetButtons.forEach(b => b.setAttribute('aria-pressed', b.dataset.mode === mode ? 'true' : 'false'));
      // run the preset
      runPreset(mode);
    }
  </script>
</body>
</html>
